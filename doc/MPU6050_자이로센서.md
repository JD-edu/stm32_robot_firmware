# STM32에서 MPU6050 자이로 데이터를 읽는 방법 (튜토리얼)

MPU6050의 자이로센서를 사용하려면 먼저 초기 설정을 수행한 후, 데이터를 읽어오는 과정이 필요합니다.

---

## 1. 자이로센서 초기 설정 (Gyroscope Configuration)

MPU6050의 자이로센서는 각속도(°/s, degrees per second)를 출력하며, 설정에 따라 감도를 조절할 수 있습니다.

### 초기 설정해야 할 레지스터

| 설정 항목 | 레지스터 주소 | 설정 내용 |
|----------|-------------|----------|
| 절전 해제 | 0x6B (PWR_MGMT_1) | 0x00 (Sleep 모드 해제) |
| 자이로 범위 설정 | 0x1B (GYRO_CONFIG) | ±250°/s, ±500°/s, ±1000°/s, ±2000°/s 중 선택 |
| 샘플링 속도 설정 | 0x19 (SMPLRT_DIV) | 샘플링 주기 설정 |
| 저역 통과 필터 설정 | 0x1A (CONFIG) | 노이즈 제거용 DLPF 설정 |

### GYRO_CONFIG (0x1B) 레지스터 구조

| 비트 | 값 | 설정된 자이로 범위 | 감도 (LSB/°/s) |
|------|----|----------------|---------------|
| 4:3  | 00 | ±250°/s (기본값) | 131 LSB/°/s |
| 4:3  | 01 | ±500°/s | 65.5 LSB/°/s |
| 4:3  | 10 | ±1000°/s | 32.8 LSB/°/s |
| 4:3  | 11 | ±2000°/s | 16.4 LSB/°/s |

💡 자이로 값을 실제 단위(°/s)로 변환하는 공식:
```c
Gyro(°/s) = RawValue / Sensitivity
```

예를 들어, ±250°/s 설정일 때 Raw 값이 13100이면 100°/s에 해당.

---

## 2. 자이로 초기화 코드

MPU6050의 자이로를 설정하는 함수입니다.

```c
void MPU6050_Init(void) {
    // 1️⃣ 절전 모드 해제 (PWR_MGMT_1)
    MPU6050_Write(0x6B, 0x00);
    HAL_Delay(100);

    // 2️⃣ 자이로 범위 설정 (±250°/s)
    MPU6050_Write(0x1B, 0x00);  // 00 = ±250°/s
    HAL_Delay(10);

    // 3️⃣ 샘플링 속도 설정 (SMPLRT_DIV)
    MPU6050_Write(0x19, 0x07);  // 1kHz / (1 + 7) = 125Hz 샘플링
    HAL_Delay(10);

    // 4️⃣ 저역 통과 필터 설정 (CONFIG)
    MPU6050_Write(0x1A, 0x03);  // 44Hz 필터 적용
    HAL_Delay(10);
}
```

✔ 자이로 범위를 ±250°/s로 설정하면 감도가 가장 높아짐 (131 LSB/°/s)
✔ 필요에 따라 ±500, ±1000, ±2000°/s로 변경 가능

---

## 3. 자이로 데이터 읽기

### 자이로 데이터 레지스터 (X, Y, Z)

| 데이터 | 레지스터 주소 (HEX) |
|--------|------------------|
| GYRO_XOUT_H (X축 상위 바이트) | 0x43 |
| GYRO_XOUT_L (X축 하위 바이트) | 0x44 |
| GYRO_YOUT_H (Y축 상위 바이트) | 0x45 |
| GYRO_YOUT_L (Y축 하위 바이트) | 0x46 |
| GYRO_ZOUT_H (Z축 상위 바이트) | 0x47 |
| GYRO_ZOUT_L (Z축 하위 바이트) | 0x48 |

### 자이로 데이터 읽기 함수

```c
void MPU6050_ReadGyro(int16_t* gx, int16_t* gy, int16_t* gz) {
    uint8_t buffer[6];  // 자이로 데이터 6바이트 (X, Y, Z)

    MPU6050_Read(0x43, buffer, 6);

    *gx = (int16_t)(buffer[0] << 8 | buffer[1]);  // X축
    *gy = (int16_t)(buffer[2] << 8 | buffer[3]);  // Y축
    *gz = (int16_t)(buffer[4] << 8 | buffer[5]);  // Z축
}
```

---

## 4. 메인 코드 (MPU6050 초기화 및 자이로 데이터 출력)

```c
int main(void) {
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_I2C1_Init();  // CubeMX에서 자동 생성된 I2C 초기화

    MPU6050_Init();  // MPU6050 초기화

    int16_t gx, gy, gz;

    while (1) {
        MPU6050_ReadGyro(&gx, &gy, &gz);

        printf("Gyro X: %d, Y: %d, Z: %d\n", gx, gy, gz);

        HAL_Delay(500);
    }
}
```

---

## 5. 설정 변경 시 어떻게 되나요?

| 설정값 | 자이로 범위 | 감도 (LSB/°/s) | 출력 값 변화 |
|--------|-----------|---------------|------------|
| 0x00   | ±250°/s  | 131 LSB/°/s   | 값이 큼, 높은 감도 |
| 0x08   | ±500°/s  | 65.5 LSB/°/s  | 중간 감도 |
| 0x10   | ±1000°/s | 32.8 LSB/°/s  | 낮은 감도 |
| 0x18   | ±2000°/s | 16.4 LSB/°/s  | 가장 낮은 감도, 값이 작아짐 |

✔ 감도가 높을수록(±250°/s) 작은 움직임에도 민감하게 반응
✔ 감도가 낮을수록(±2000°/s) 큰 움직임을 감지할 때 유리

예제: ±1000°/s로 변경
```c
MPU6050_Write(0x1B, 0x10);  // ±1000°/s 설정
```

---

## 6. 정리

✔ MPU6050 자이로는 16비트 (X, Y, Z) 각속도를 제공
✔ 자이로 범위는 GYRO_CONFIG(0x1B)에서 설정
✔ 자이로 데이터를 읽고 변환하려면 감도(LSB/°/s)에 따라 계산
✔ 설정 변경 시 감도가 바뀌며, 값의 크기가 달라짐

🚀 이제 STM32에서 MPU6050의 자이로 데이터를 정확하게 읽을 수 있습니다!

다음으로 자이로 데이터를 필터링(보정)하는 방법도 필요하시면 알려주세요! 😊

